# See: https://docs.github.com/en/actions/writing-workflows
---
name: Build & Release ASIMOV rust module

on:
  workflow_call:
    inputs:
      version:
        required: false
        type: string
        default: ${{ github.ref_name }}
      create_release:
        required: false
        type: boolean
        default: true
      update_homebrew_tap:
        required: false
        type: boolean
        default: false
      update_scoop_bucket:
        required: false
        type: boolean
        default: false
      update_crates_io:
        required: false
        type: boolean
        default: false
      tweet_release:
        required: false
        type: boolean
        default: false
      build-linux-x86-gnu:
        required: false
        description: Build Linux x86 GNU binary?
        type: boolean
        default: true
      build-linux-x86-musl:
        required: false
        description: Build Linux x86 MUSL binary?
        type: boolean
        default: true
      build-linux-arm-gnu:
        required: false
        description: Build Linux ARM GNU binary?
        type: boolean
        default: true
      build-linux-arm-musl:
        required: false
        description: Build Linux ARM MUSL binary?
        type: boolean
        default: true
      build-macos-x86:
        required: false
        description: Build macOS x86 binary?
        type: boolean
        default: true
      build-macos-arm:
        required: false
        description: Build macOS ARM binary?
        type: boolean
        default: true
      build-windows:
        required: false
        description: Build Windows binary?
        type: boolean
        default: true
      build-windows-native:
        required: false
        description: Build Windows binary natively (meaning on Windows, without cross-compiling)?
        type: boolean
        default: false
    secrets:
      ASIMOV_APP_ID:
        required: true
      ASIMOV_APP_PRIVATE_KEY:
        required: true

jobs:
  build:
    name: Prepare Homebrew
    if: ${{ inputs.update_homebrew_tap }}
    uses: asimov-platform/actions/.github/workflows/build-and-release-rust-package.yaml@master
    secrets:
      ASIMOV_APP_ID: ${{ secrets.ASIMOV_APP_ID }}
      ASIMOV_APP_PRIVATE_KEY: ${{ secrets.ASIMOV_APP_PRIVATE_KEY }}
    with:
      version: ${{ inputs.version }}
      create_release: ${{ inputs.create_release }}
      update_homebrew_tap: ${{ inputs.update_homebrew_tap }}
      update_scoop_bucket: ${{ inputs.update_scoop_bucket }}
      update_crates_io: ${{ inputs.update_crates_io }}
      build-linux-x86-gnu: ${{ inputs.build-linux-x86-gnu }}
      build-linux-x86-musl: ${{ inputs.build-linux-x86-musl }}
      build-linux-arm-gnu: ${{ inputs.build-linux-arm-gnu }}
      build-linux-arm-musl: ${{ inputs.build-linux-arm-musl }}
      build-macos-x86: ${{ inputs.build-macos-x86 }}
      build-macos-arm: ${{ inputs.build-macos-arm }}
      build-windows: ${{ inputs.build-windows }}
      build-windows-native: ${{ inputs.build-windows-native }}

  tweet-release:
    name: Tweet release
    if: ${{ inputs.tweet_release }}
    needs: build
    uses: asimov-modules/.github/.github/workflows/tweet.yaml@master
    secrets:
      ASIMOV_APP_ID: ${{ secrets.ASIMOV_APP_ID }}
      ASIMOV_APP_PRIVATE_KEY: ${{ secrets.ASIMOV_APP_PRIVATE_KEY }}
    with:
      message: |
        ðŸ“¦ ${{ github.event.repository.name }} ${{ github.ref_name }} has been released:
        ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}
